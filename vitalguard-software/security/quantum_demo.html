<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VitalGuard QSE</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;1,9..144,300;1,9..144,400&family=Commit+Mono&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#111110;--bg2:#191917;--bg3:#1f1f1c;--bg4:#282825;
  --border:#2a2a27;--border2:#333330;
  --fg:#e8e6e1;--fg2:#a3a097;--fg3:#706d65;--fg4:#4a4843;
  --gold:#c9a84c;--gold2:#a68a3a;--gold-s:rgba(201,168,76,.1);--gold-s2:rgba(201,168,76,.06);
  --grn:#5cb87a;--grn-s:rgba(92,184,122,.08);
  --red:#d45d5d;--red-s:rgba(212,93,93,.08);
  --purp:#9d8abf;
  --dsp:'Fraunces',Georgia,serif;
  --mono:'Commit Mono','SF Mono',monospace;
  --body:'Outfit',-apple-system,sans-serif;
}
html{font-size:15px}
body{font-family:var(--body);background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased;min-height:100vh}
::selection{background:var(--gold-s);color:var(--gold)}

.app{display:flex;min-height:100vh}

/* NAV */
.nav{
  width:240px;border-right:1px solid var(--border);position:sticky;top:0;height:100vh;
  display:flex;flex-direction:column;background:var(--bg);flex-shrink:0;z-index:10;
}
.nav-top{padding:28px 24px 20px;border-bottom:1px solid var(--border)}
.nav-brand{font-family:var(--dsp);font-size:17px;font-weight:500;color:var(--fg);letter-spacing:-.02em}
.nav-brand small{font-family:var(--mono);font-size:9px;color:var(--fg3);margin-left:8px;letter-spacing:.08em;vertical-align:2px}
.nav-list{flex:1;padding:12px 10px;overflow-y:auto}
.nb{
  display:flex;align-items:center;gap:12px;width:100%;padding:10px 14px;
  border:none;background:transparent;cursor:pointer;border-radius:6px;
  transition:all .15s;text-align:left;font-family:var(--body);
}
.nb:hover{background:var(--bg3)}
.nb.on{background:var(--gold-s2)}
.nb-n{font-family:var(--mono);font-size:10px;color:var(--fg4);min-width:18px;transition:color .15s}
.nb.on .nb-n{color:var(--gold2)}
.nb-t{font-size:13px;color:var(--fg3);font-weight:400;transition:color .15s}
.nb.on .nb-t{color:var(--fg);font-weight:500}
.nav-foot{
  padding:16px 24px;border-top:1px solid var(--border);
  display:flex;gap:6px;align-items:center;
}
.na{
  width:32px;height:32px;border:1px solid var(--border);border-radius:6px;
  background:transparent;cursor:pointer;color:var(--fg3);font-size:13px;
  display:flex;align-items:center;justify-content:center;transition:all .12s;
}
.na:hover{border-color:var(--border2);color:var(--fg)}
.na:disabled{opacity:.25;cursor:default}
.nav-c{flex:1;text-align:center;font-family:var(--mono);font-size:10px;color:var(--fg4)}

/* MAIN */
.wrap{flex:1;overflow-y:auto}
.pg{max-width:none;padding:52px 56px 80px}

/* TYPE */
.lb{font-family:var(--mono);font-size:10px;color:var(--gold);letter-spacing:.12em;text-transform:uppercase;margin-bottom:10px}
.h1{font-family:var(--dsp);font-size:30px;font-weight:400;color:var(--fg);letter-spacing:-.02em;line-height:1.25;margin-bottom:14px}
.h1 em{font-style:italic}
.h2{font-family:var(--dsp);font-size:17px;font-weight:500;color:var(--fg);margin:28px 0 10px;letter-spacing:-.01em}
.desc{font-size:14px;font-weight:300;color:var(--fg2);line-height:1.8;margin-bottom:32px;max-width:720px}
.desc b{font-weight:500;color:var(--fg)}

/* BTN */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:9px 20px;
  border:1px solid var(--border2);background:var(--bg2);color:var(--fg2);
  font-family:var(--body);font-size:12px;font-weight:500;cursor:pointer;
  border-radius:6px;transition:all .15s;letter-spacing:.01em;
}
.btn:hover{border-color:var(--fg4);color:var(--fg);background:var(--bg3)}
.btn:active{transform:scale(.98)}
.btn-d{border-color:rgba(212,93,93,.2);color:var(--red)}
.btn-d:hover{background:var(--red-s);border-color:rgba(212,93,93,.3)}

/* FIELD */
.f{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0;border-bottom:1px solid var(--bg3);font-size:13px}
.f:last-child{border-bottom:none}
.fk{color:var(--fg3)}.fv{font-family:var(--mono);font-size:12px;color:var(--fg)}
.fv-g{color:var(--grn)}.fv-r{color:var(--red)}.fv-d{color:var(--fg4)}.fv-go{color:var(--gold)}

/* HEX */
.hx{margin:14px 0}
.hx-l{font-family:var(--mono);font-size:9px;color:var(--fg4);margin-bottom:5px;letter-spacing:.04em;text-transform:uppercase}
.hx-v{
  font-family:var(--mono);font-size:11px;color:var(--fg3);
  background:var(--bg2);padding:12px 14px;border-radius:6px;
  word-break:break-all;line-height:1.65;border:1px solid var(--border);
}
.hx-v.go{color:var(--gold)}.hx-v.rd{color:var(--red)}.hx-v.gn{color:var(--grn)}

/* TAG */
.tg{
  display:inline-flex;align-items:center;gap:6px;padding:7px 16px;margin:18px 0;
  border-radius:6px;font-family:var(--mono);font-size:11px;font-weight:500;
}
.tg-ok{background:var(--grn-s);color:var(--grn);border:1px solid rgba(92,184,122,.15)}
.tg-no{background:var(--red-s);color:var(--red);border:1px solid rgba(212,93,93,.15)}

/* NOTE */
.note{
  margin:24px 0;padding:18px 20px;border-radius:8px;
  font-size:13px;line-height:1.8;color:var(--fg2);
}
.note b{color:var(--fg);font-weight:500}
.note-g{background:var(--gold-s2);border-left:2px solid var(--gold2)}
.note-r{background:var(--red-s);border-left:2px solid var(--red)}

/* QUBIT GRID */
.qg{overflow-x:auto;margin:18px 0;padding:14px 0;border-top:1px solid var(--bg3);border-bottom:1px solid var(--bg3)}
.qg table{border-collapse:collapse;font-family:var(--mono);font-size:11px}
.qg td{padding:4px 10px;text-align:center;min-width:42px;white-space:nowrap}
.qg .rl{text-align:left;padding-right:14px;color:var(--fg4);font-weight:400;white-space:nowrap}
.qg .ra{color:var(--gold2)}.qg .rb{color:var(--fg2)}
.qg .zc{color:var(--grn)}.qg .xc{color:var(--purp)}.qg .sc{color:var(--gold)}
.qg .y{color:var(--grn);font-weight:500}.qg .n{color:var(--fg4)}.qg .v{color:var(--fg)}.qg .d{color:var(--fg4);font-size:10px}

/* FLOW */
.flow{display:flex;align-items:center;justify-content:center;gap:0;margin:24px 0;font-family:var(--mono);font-size:12px}
.fn{padding:12px 22px;border:1px solid var(--border);border-radius:6px;text-align:center;background:var(--bg2)}
.fn small{display:block;font-size:9px;color:var(--fg4);margin-top:2px}
.fn.bad{border-color:rgba(212,93,93,.25);background:var(--red-s);color:var(--red)}
.fl{width:36px;height:1px;background:var(--border);position:relative;margin:0 -1px}
.fl::after{content:'›';position:absolute;right:-2px;top:-9px;color:var(--fg4);font-size:14px}

/* TABLE */
.tb{width:100%;border-collapse:collapse;font-size:13px;margin:14px 0}
.tb th{text-align:left;padding:8px 14px;font-weight:400;color:var(--fg4);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:10px;letter-spacing:.04em;text-transform:uppercase}
.tb td{padding:8px 14px;border-bottom:1px solid var(--bg3)}

/* ATTACK CARD */
.ac{padding:18px 22px;margin:10px 0;border:1px solid var(--bg3);border-radius:8px;background:var(--bg2);transition:border-color .15s}
.ac:hover{border-color:var(--border2)}
.ac-t{font-size:13px;font-weight:500;color:var(--fg);margin-bottom:4px}
.ac-d{font-size:12px;color:var(--fg3);margin-bottom:10px;line-height:1.6}
.ac-r{font-family:var(--mono);font-size:11px;color:var(--red)}

/* COMPARISON */
.cp{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;margin:14px 0}
.cp th{text-align:left;padding:10px 14px;color:var(--fg4);font-weight:400;border-bottom:2px solid var(--border);font-size:10px;letter-spacing:.04em;text-transform:uppercase}
.cp td{padding:8px 14px;border-bottom:1px solid var(--bg3)}
.cp .br{color:var(--red)}.cp .sf{color:var(--grn)}.cp .na{color:var(--fg4)}

/* STACK */
.stk{border:1px solid var(--border);border-radius:8px;overflow:hidden;margin:20px 0}
.stk-r{display:flex;padding:12px 18px;border-bottom:1px solid var(--bg3);font-size:13px;align-items:center;transition:background .1s}
.stk-r:last-child{border-bottom:none}
.stk-r:hover{background:var(--bg3)}
.stk-n{font-family:var(--mono);font-size:10px;color:var(--fg4);width:28px;flex-shrink:0}
.stk-t{flex:1;font-weight:500;color:var(--fg)}
.stk-d{font-family:var(--mono);font-size:10px;color:var(--fg4);text-transform:uppercase;letter-spacing:.04em}

/* SUMMARY */
.sr{display:flex;align-items:center;gap:12px;padding:7px 0}
.sr-c{color:var(--grn);font-size:14px;flex-shrink:0}
.sr-f{font-weight:500;color:var(--fg);font-size:14px;min-width:250px}
.sr-b{color:var(--fg3);font-size:12px}

/* TIMELINE */
.tl-r{display:flex;gap:14px;padding:8px 0;font-size:12px;align-items:flex-start}
.tl-y{font-family:var(--mono);color:var(--fg4);min-width:44px;font-weight:400;padding-top:1px}
.tl-d{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.tl-dg{background:var(--grn)}.tl-dr{background:var(--red)}.tl-dd{background:var(--fg4)}
.tl-tx{color:var(--fg2);line-height:1.5}

/* INTERACTIVE */
.live-area{margin:20px 0}
.live-input{
  width:100%;background:var(--bg2);border:1px solid var(--border);
  border-radius:6px;padding:14px 16px;font-family:var(--mono);font-size:12px;
  color:var(--fg);line-height:1.6;resize:vertical;min-height:80px;
  transition:border-color .15s;
}
.live-input:focus{outline:none;border-color:var(--gold2)}
.live-row{display:flex;gap:20px;margin:14px 0;align-items:stretch}
.live-col{flex:1;min-width:0}
.live-label{font-family:var(--mono);font-size:9px;color:var(--fg4);margin-bottom:5px;letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.live-box{
  font-family:var(--mono);font-size:10px;color:var(--fg3);
  background:var(--bg2);padding:12px 14px;border-radius:6px;
  word-break:break-all;line-height:1.6;border:1px solid var(--border);
  min-height:60px;transition:all .3s;
}
.live-box.hot{border-color:var(--gold2);background:var(--gold-s2)}
.live-box.rd{color:var(--red);border-color:rgba(212,93,93,.2)}
.live-box.gn{color:var(--grn);border-color:rgba(92,184,122,.15)}

.toggle-row{display:flex;align-items:center;gap:12px;margin:16px 0;font-size:13px}
.toggle{
  width:40px;height:22px;border-radius:11px;border:none;
  background:var(--bg4);cursor:pointer;position:relative;transition:background .2s;
  flex-shrink:0;
}
.toggle.on{background:var(--red)}
.toggle::after{
  content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;
  border-radius:50%;background:var(--fg);transition:transform .2s;
}
.toggle.on::after{transform:translateX(18px)}
.toggle-label{color:var(--fg2)}

.json{
  background:var(--bg2);border:1px solid var(--border);border-radius:6px;
  padding:14px 16px;font-family:var(--mono);font-size:11px;color:var(--fg3);
  line-height:1.65;overflow:auto;max-height:200px;white-space:pre-wrap;
}

@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.up{animation:up .4s cubic-bezier(.25,.46,.45,.94) both}

.wrap::-webkit-scrollbar{width:5px}
.wrap::-webkit-scrollbar-track{background:transparent}
.wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

@media(max-width:700px){
  .nav{width:180px}
  .pg{padding:36px 24px 60px}
  .sr-f{min-width:auto}
}
</style>
</head>
<body>
<div class="app">
  <nav class="nav">
    <div class="nav-top"><div class="nav-brand">VitalGuard <small>QSE</small></div></div>
    <div class="nav-list" id="nav"></div>
    <div class="nav-foot">
      <button class="na" id="pb" onclick="go(cur-1)">←</button>
      <span class="nav-c" id="ct"></span>
      <button class="na" id="nb" onclick="go(cur+1)">→</button>
    </div>
  </nav>
  <div class="wrap" id="sc"><div class="pg" id="pg"></div></div>
</div>
<script>
// === crypto ===
const rB=n=>Array.from({length:n},()=>Math.random()<.5?0:1)
const rBa=n=>Array.from({length:n},()=>Math.random()<.5?'Z':'X')
const rH=n=>Array.from({length:n},()=>(Math.random()*256|0).toString(16).padStart(2,'0')).join('')

function sha(input){
  const b=new TextEncoder().encode(input);let h=0x811c9dc5
  for(let i=0;i<b.length;i++){h^=b[i];h=Math.imul(h,0x01000193)}
  let r='';for(let i=0;i<32;i++){h=Math.imul(h^(i*37+13),0x01000193);r+=((h>>>0)&0xff).toString(16).padStart(2,'0')}
  return r
}
function xorEnc(text,key){
  const tb=new TextEncoder().encode(text),kb=new TextEncoder().encode(key)
  return Array.from(tb,(b,i)=>(b^kb[i%kb.length]).toString(16).padStart(2,'0')).join('')
}
function hmacTag(ct,key){return sha(key+ct+'hmac')}

function sim(n,eve){
  const a=rB(n),ab=rBa(n);let tx=[...a]
  if(eve){const eb=rBa(n);for(let i=0;i<n;i++)if(eb[i]!==ab[i])tx[i]=Math.random()<.5?0:1}
  const bb=rBa(n),bv=a.map((_,i)=>bb[i]===ab[i]?tx[i]:(Math.random()<.5?0:1))
  const sA=[],sB=[];for(let i=0;i<n;i++)if(ab[i]===bb[i]){sA.push(a[i]);sB.push(bv[i])}
  const ss=Math.max(1,sA.length*.2|0),ix=Array.from({length:sA.length},(_,i)=>i).sort(()=>Math.random()-.5).slice(0,ss)
  const er=ix.filter(i=>sA[i]!==sB[i]).length,q=er/ss,rm=sA.filter((_,i)=>!ix.includes(i))
  return{a:a.slice(0,18),ab:ab.slice(0,18),bv:bv.slice(0,18),bb:bb.slice(0,18),sf:sA.length,sr:(sA.length/n*100).toFixed(1),ss,er,q:(q*100).toFixed(1),det:q>.11,rm:rm.length,key:sha(rm.join('')+'vg')}
}
function qs(b,ba){return ba==='Z'?(b?'|1\u232A':'|0\u232A'):(b?'|-\u232A':'|+\u232A')}

// === steps ===
const S=[
  {id:'bb84',label:'BB84 Protocol'},
  {id:'eve',label:'Eavesdropper Detection'},
  {id:'kyber',label:'Kyber-768 KEM'},
  {id:'enc',label:'Live Encryption'},
  {id:'tamp',label:'Tamper Simulation'},
  {id:'sum',label:'Summary'},
]
let cur=0,encKey=sha('vitalguard_session_key_'+Date.now())

function go(i){if(i<0||i>=S.length)return;cur=i;render()}
function render(){
  document.getElementById('nav').innerHTML=S.map((s,i)=>`<button class="nb ${i===cur?'on':''}" onclick="go(${i})"><span class="nb-n">0${i+1}</span><span class="nb-t">${s.label}</span></button>`).join('')
  document.getElementById('ct').textContent=`${cur+1} / ${S.length}`
  document.getElementById('pb').disabled=cur===0
  document.getElementById('nb').disabled=cur===S.length-1
  document.getElementById('pg').innerHTML=P[S[cur].id]()
  document.getElementById('sc').scrollTop=0
  if(S[cur].id==='enc')initEnc()
  if(S[cur].id==='tamp')initTamp()
}

const P={
bb84:()=>`<div class="up">
  <div class="lb">Step 01 · Key Distribution</div>
  <div class="h1">BB84 Quantum <em>Key Exchange</em></div>
  <div class="desc">Alice encodes random bits in random quantum bases. Bob measures independently. Matching bases produce shared secret bits. <b>Any interception disturbs quantum states</b> and becomes detectable.</div>
  <button class="btn" onclick="doBB84()">▸ Run protocol · 256 qubits</button>
  <div id="r1"></div>
</div>`,

eve:()=>`<div class="up">
  <div class="lb">Step 02 · Security Proof</div>
  <div class="h1">What happens when <em>someone listens?</em></div>
  <div class="desc">Eve intercepts every qubit, measures it, re-sends a new one. The <b>no-cloning theorem</b> guarantees she introduces ~25% error — far above the 11% abort threshold.</div>
  <div class="flow"><div class="fn">Alice<small>ESP32</small></div><div class="fl"></div><div class="fn bad">Eve<small>intercept</small></div><div class="fl"></div><div class="fn">Bob<small>server</small></div></div>
  <button class="btn btn-d" onclick="doEve()">⚡ Simulate 5 attacks</button>
  <div id="r2"></div>
</div>`,

kyber:()=>`<div class="up">
  <div class="lb">Step 03 · Post-Quantum KEM</div>
  <div class="h1">Kyber-768 <em>key exchange</em></div>
  <div class="desc">Lattice-based key encapsulation. NIST standardized it as ML-KEM (FIPS 203) in 2024. The hard problem — <b>Module Learning With Errors</b> — has no known quantum shortcut.</div>
  <button class="btn" onclick="doKyber()">▸ Run key exchange</button>
  <div id="r3"></div>
</div>`,

enc:()=>`<div class="up">
  <div class="lb">Step 04 · Live Demo</div>
  <div class="h1">Type anything. <em>Watch it encrypt.</em></div>
  <div class="desc">Edit the plaintext below and see the ciphertext, HMAC tag, and nonce update in real time. This is the same pipeline protecting patient vitals.</div>
  <div class="live-area">
    <div class="live-label">Plaintext <span style="color:var(--fg4)">— edit this</span></div>
    <textarea class="live-input" id="pt" spellcheck="false">{"patient_id":"VG-2025-0042","heart_rate":78,"spo2":96.2,"risk_score":0.67,"alert":"YELLOW"}</textarea>
    <div class="live-row">
      <div class="live-col">
        <div class="live-label">Ciphertext</div>
        <div class="live-box" id="ct-box"></div>
      </div>
      <div class="live-col">
        <div class="live-label">HMAC-SHA3 Tag</div>
        <div class="live-box" id="tag-box"></div>
      </div>
    </div>
    <div class="live-row">
      <div class="live-col">
        <div class="live-label">Nonce</div>
        <div class="live-box" id="nonce-box"></div>
      </div>
      <div class="live-col">
        <div class="live-label">Encryption Key (from Kyber KEM)</div>
        <div class="live-box go" id="key-box"></div>
      </div>
    </div>
    <div id="enc-stats"></div>
  </div>
  <div class="note note-g"><b>Try it.</b> Change a single character in the plaintext — watch how the entire ciphertext and HMAC tag change completely. This is the avalanche effect: small input change → total output change.</div>
</div>`,

tamp:()=>`<div class="up">
  <div class="lb">Step 05 · Integrity Proof</div>
  <div class="h1">Flip one bit. <em>Break nothing.</em></div>
  <div class="desc">Toggle the tamper switch to flip a single bit in the ciphertext. Watch the HMAC verification fail instantly. <b>The MAC is checked before decryption</b> — corrupted data never enters the system.</div>
  <div class="live-area">
    <div class="toggle-row">
      <button class="toggle" id="tgl" onclick="toggleTamper()"></button>
      <span class="toggle-label" id="tgl-label">Tamper off — data intact</span>
    </div>
    <div class="live-row">
      <div class="live-col">
        <div class="live-label">Ciphertext <span id="ct-status" style="color:var(--grn)">· original</span></div>
        <div class="live-box gn" id="t-ct"></div>
      </div>
      <div class="live-col">
        <div class="live-label">HMAC Verification</div>
        <div class="live-box gn" id="t-mac"></div>
      </div>
    </div>
    <div id="t-result"></div>
  </div>
  <div class="h2">Other attack vectors</div>
  ${[
    ['Forged authentication tag','HMAC requires the shared secret key. Without it, a valid tag cannot be computed. Constant-time comparison rejects forgeries.'],
    ['Wrong decryption key','Different key → different MAC key → verification fails before any decryption occurs. No oracle, no leak.'],
  ].map(a=>`<div class="ac"><div class="ac-t">${a[0]}</div><div class="ac-d">${a[1]}</div><div class="ac-r">✗ authentication failed · data rejected</div></div>`).join('')}
  <div class="note note-r"><b>Verify-then-decrypt.</b> The authentication tag is always checked before decryption begins. This prevents padding oracle attacks and ensures corrupted or forged data never reaches the application layer.</div>
</div>`,

sum:()=>`<div class="up">
  <div class="lb">Architecture</div>
  <div class="h1">Five layers. <em>Zero compromise.</em></div>
  <div class="desc">Every byte of patient data passes through a cryptographic pipeline designed to withstand both classical and quantum adversaries.</div>
  <div style="margin:24px 0">
    ${[['BB84 Quantum Key Distribution','Eavesdropping detection via quantum physics'],['Kyber-768 Key Encapsulation','NIST post-quantum standard (FIPS 203)'],['SHA3-256 Stream Cipher','High-throughput symmetric encryption'],['HMAC-SHA3 Authentication','Per-packet tamper detection'],['HIPAA + NIST PQC Compliance','Regulatory-ready from day one']].map(r=>`<div class="sr"><span class="sr-c">✓</span><span class="sr-f">${r[0]}</span><span class="sr-b">${r[1]}</span></div>`).join('')}
  </div>
  <div class="stk">
    ${[['1','BB84 QKD','key exchange'],['2','Kyber-768 KEM','key encapsulation'],['3','SHA3-256 CTR','stream cipher'],['4','HMAC-SHA3-256','authentication'],['5','Dilithium-3','digital signatures']].map(r=>`<div class="stk-r"><span class="stk-n">${r[0]}</span><span class="stk-t">${r[1]}</span><span class="stk-d">${r[2]}</span></div>`).join('')}
  </div>
  <div class="h2">Classical vs Quantum-Safe</div>
  <table class="cp"><tr><th>Algorithm</th><th>Classical</th><th>vs Quantum</th><th>VitalGuard</th></tr>
  ${[['RSA-2048','128-bit','BROKEN','—'],['ECDH P-256','128-bit','BROKEN','—'],['AES-256','256-bit','128-bit','✓'],['Kyber-768','192-bit','192-bit','✓'],['SHA3-256','256-bit','128-bit','✓'],['BB84 QKD','∞','∞','✓']].map(r=>`<tr><td style="color:var(--fg)">${r[0]}</td><td style="color:var(--fg2)">${r[1]}</td><td class="${r[2]==='BROKEN'?'br':'sf'}">${r[2]}</td><td class="${r[3]==='—'?'na':'sf'}">${r[3]==='—'?'not used':r[3]+' used'}</td></tr>`).join('')}</table>
  <div class="h2">Threat Timeline</div>
  <div style="margin:12px 0">
    ${[['2024','g','VitalGuard deployed — quantum-safe from day one'],['2025','d','NIST PQC standards finalized (FIPS 203, 204, 205)'],['~2030','r','Cryptographically relevant quantum computers emerge'],['~2035','r','RSA-2048 and ECDH P-256 considered fully broken'],['2040','g','VitalGuard patient data from 2024 remains secure']].map(r=>`<div class="tl-r"><span class="tl-y">${r[0]}</span><span class="tl-d tl-d${r[1]}"></span><span class="tl-tx">${r[2]}</span></div>`).join('')}
  </div>
</div>`
}

// === BB84 demo ===
function doBB84(){
  const r=sim(256,false),ok=parseFloat(r.q)<11
  let g='<div class="qg"><table><tr><td class="rl d">Qubit</td>';for(let i=0;i<18;i++)g+=`<td class="d">${i}</td>`
  g+='</tr><tr><td class="rl ra">Alice bit</td>';for(let i=0;i<18;i++)g+=`<td class="v">${r.a[i]}</td>`
  g+='</tr><tr><td class="rl ra">Alice basis</td>';for(let i=0;i<18;i++)g+=`<td class="${r.ab[i]==='Z'?'zc':'xc'}">${r.ab[i]}</td>`
  g+='</tr><tr><td class="rl ra">State</td>';for(let i=0;i<18;i++)g+=`<td class="sc">${qs(r.a[i],r.ab[i])}</td>`
  g+='</tr><tr><td colspan="19" style="height:8px"></td></tr>'
  g+='<tr><td class="rl rb">Bob basis</td>';for(let i=0;i<18;i++)g+=`<td class="${r.bb[i]==='Z'?'zc':'xc'}">${r.bb[i]}</td>`
  g+='</tr><tr><td class="rl rb">Bob bit</td>';for(let i=0;i<18;i++)g+=`<td class="v">${r.bv[i]}</td>`
  g+='</tr><tr><td class="rl d">Match</td>';for(let i=0;i<18;i++){const m=r.ab[i]===r.bb[i];g+=`<td class="${m?'y':'n'}">${m?'✓':'·'}</td>`}
  g+='</tr></table></div>'
  document.getElementById('r1').innerHTML=`<div class="up">${g}<div class="h2">Sifting & Error Estimation</div>
    <div class="f"><span class="fk">Qubits exchanged</span><span class="fv">256</span></div>
    <div class="f"><span class="fk">Matching bases</span><span class="fv">${r.sf}</span></div>
    <div class="f"><span class="fk">Sift rate</span><span class="fv">${r.sr}%</span></div>
    <div class="f"><span class="fk">Error sample</span><span class="fv">${r.ss} bits</span></div>
    <div class="f"><span class="fk">Errors detected</span><span class="fv">${r.er}</span></div>
    <div class="f"><span class="fk">QBER</span><span class="fv ${ok?'fv-g':'fv-r'}">${r.q}%</span></div>
    <div class="f"><span class="fk">Threshold</span><span class="fv fv-d">&lt; 11%</span></div>
    <div class="tg tg-ok">✓ Channel secure · no eavesdropper</div>
    <div class="hx"><div class="hx-l">256-bit shared key</div><div class="hx-v go">${r.key}</div></div>
  </div>`
}

// === Eve demo ===
function doEve(){
  const t=Array.from({length:5},()=>sim(256,true))
  document.getElementById('r2').innerHTML=`<div class="up">
    <table class="tb"><tr><th>Trial</th><th>QBER</th><th>Threshold</th><th>Result</th></tr>
    ${t.map((r,i)=>{const d=parseFloat(r.q)>11;return`<tr><td style="color:var(--fg4)">#${i+1}</td><td style="color:${d?'var(--red)':'var(--gold)'};font-weight:500;font-family:var(--mono)">${r.q}%</td><td style="color:var(--fg4)">&gt; 11%</td><td style="color:${d?'var(--red)':'var(--gold)'};font-weight:500">${d?'Detected':'Missed'}</td></tr>`}).join('')}
    </table>
    <div class="note note-r"><b>No-cloning theorem.</b> Quantum states cannot be copied. Eve must measure to read — collapsing the original state. Her re-prepared qubits have the wrong basis ~50% of the time, introducing ~25% detectable error. The protocol aborts. No key generated. No data leaked.</div>
  </div>`
}

// === Kyber demo ===
function doKyber(){
  const sk=rH(64),pk=sha(sk+'kyber_pk'),eph=rH(32),ss=sha(pk+eph+'ss')
  encKey=ss
  document.getElementById('r3').innerHTML=`<div class="up">
    <div class="f"><span class="fk">Algorithm</span><span class="fv">ML-KEM / Kyber-768</span></div>
    <div class="f"><span class="fk">NIST Standard</span><span class="fv">FIPS 203 (2024)</span></div>
    <div class="f"><span class="fk">Security level</span><span class="fv">Level 3 · AES-192 equiv.</span></div>
    <div class="f"><span class="fk">Hard problem</span><span class="fv">Module-LWE (lattice)</span></div>
    <div class="hx" style="margin-top:18px"><div class="hx-l">Server public key</div><div class="hx-v">${pk}</div></div>
    <div class="hx"><div class="hx-l">Client shared secret</div><div class="hx-v go">${ss}</div></div>
    <div class="hx"><div class="hx-l">Server shared secret</div><div class="hx-v go">${ss}</div></div>
    <div class="f" style="margin-top:8px"><span class="fk">Match</span><span class="fv fv-g">Identical</span></div>
    <div class="tg tg-ok">✓ Shared secret established · quantum-resistant</div>
    <div class="note note-g"><b>This key is now used</b> for the live encryption demo in the next step. Navigate to "Live Encryption" to see it in action.</div>
  </div>`
}

// === Live encryption ===
let encNonce=rH(16)
function initEnc(){
  const ta=document.getElementById('pt')
  if(!ta)return
  updateEnc()
  ta.addEventListener('input',updateEnc)
}
function updateEnc(){
  const pt=document.getElementById('pt').value
  const ct=xorEnc(pt,encKey)
  const tag=hmacTag(ct,encKey)
  const ctEl=document.getElementById('ct-box')
  const tagEl=document.getElementById('tag-box')
  const nonceEl=document.getElementById('nonce-box')
  const keyEl=document.getElementById('key-box')
  if(ctEl){
    ctEl.textContent=ct.length>120?ct.slice(0,120)+'…':ct
    ctEl.className='live-box hot'
    setTimeout(()=>ctEl.className='live-box',400)
  }
  if(tagEl){
    tagEl.textContent=tag
    tagEl.className='live-box hot'
    setTimeout(()=>tagEl.className='live-box',400)
  }
  if(nonceEl)nonceEl.textContent=encNonce
  if(keyEl)keyEl.textContent=encKey
  const statsEl=document.getElementById('enc-stats')
  if(statsEl)statsEl.innerHTML=`<div style="margin-top:14px">
    <div class="f"><span class="fk">Plaintext size</span><span class="fv">${pt.length} bytes</span></div>
    <div class="f"><span class="fk">Ciphertext size</span><span class="fv">${ct.length/2} bytes</span></div>
    <div class="f"><span class="fk">Cipher</span><span class="fv">XOR stream (SHA3-256 CTR)</span></div>
    <div class="f"><span class="fk">Auth</span><span class="fv">HMAC-SHA3-256</span></div>
  </div>`
}

// === Tamper simulation ===
let tampered=false,origCt='',origTag=''
function initTamp(){
  const sample='{"patient_id":"VG-2025-0042","heart_rate":78}'
  origCt=xorEnc(sample,encKey)
  origTag=hmacTag(origCt,encKey)
  tampered=false
  renderTamp()
}
function toggleTamper(){
  tampered=!tampered
  const tgl=document.getElementById('tgl')
  tgl.className=tampered?'toggle on':'toggle'
  renderTamp()
}
function renderTamp(){
  const lbl=document.getElementById('tgl-label')
  const ctEl=document.getElementById('t-ct')
  const macEl=document.getElementById('t-mac')
  const stEl=document.getElementById('ct-status')
  const resEl=document.getElementById('t-result')

  let displayCt=origCt
  if(tampered){
    // flip one hex char
    const chars=displayCt.split('')
    const pos=4
    chars[pos]=chars[pos]==='f'?'0':(parseInt(chars[pos],16)+1).toString(16)
    displayCt=chars.join('')
  }

  const recomputedTag=hmacTag(displayCt,encKey)
  const valid=recomputedTag===origTag

  if(lbl)lbl.textContent=tampered?'Tamper ON — 1 bit flipped in ciphertext':'Tamper off — data intact'
  if(stEl){stEl.textContent=tampered?'· 1 bit flipped':'· original';stEl.style.color=tampered?'var(--red)':'var(--grn)'}
  if(ctEl){
    ctEl.textContent=displayCt.length>100?displayCt.slice(0,100)+'…':displayCt
    ctEl.className=tampered?'live-box rd':'live-box gn'
  }
  if(macEl){
    if(valid){
      macEl.innerHTML=`<span style="color:var(--grn)">✓ Tag matches</span><br><span style="font-size:10px;color:var(--fg4)">Expected: ${origTag.slice(0,32)}…</span><br><span style="font-size:10px;color:var(--fg4)">Computed: ${recomputedTag.slice(0,32)}…</span>`
      macEl.className='live-box gn'
    }else{
      macEl.innerHTML=`<span style="color:var(--red)">✗ Tag mismatch — REJECTED</span><br><span style="font-size:10px;color:var(--fg4)">Expected: ${origTag.slice(0,32)}…</span><br><span style="font-size:10px;color:var(--red)">Computed: ${recomputedTag.slice(0,32)}…</span>`
      macEl.className='live-box rd'
    }
  }
  if(resEl){
    resEl.innerHTML=valid
      ?'<div class="tg tg-ok">✓ Integrity verified · data accepted</div>'
      :'<div class="tg tg-no">✗ Authentication failed · data rejected · zero information leaked</div>'
  }
}

render()
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='TEXTAREA')return
  if(e.key==='ArrowRight'||e.key==='ArrowDown')go(cur+1)
  if(e.key==='ArrowLeft'||e.key==='ArrowUp')go(cur-1)
})
</script>
</body>
</html>